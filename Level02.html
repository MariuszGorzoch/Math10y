<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lemon Shop - Level 02</title>
  <style>
    html,body{height:100%;margin:0}
    body{background:url('LemonBackgrund.png') repeat;background-size:50%;overflow:hidden}
    #map{position:relative;width:100%;height:100%}
    #shopWrapper{position:absolute;top:20px;left:50%;transform:translateX(-50%);width:400px;z-index:2}
    #shopWrapper{position:relative}
    #shop{width:100%;height:auto;display:block}
    #cart{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:300px;height:80px;display:flex;justify-content:space-between;pointer-events:none}
    .cartSide{display:flex;flex-wrap:wrap;width:50%;gap:1px;align-content:flex-start}
    #cartYellow{justify-content:flex-start}
    #cartRed{justify-content:flex-end}
    .cup{position:relative;font-size:24px;line-height:1}
    .cup .fruit{position:absolute;top:4px;left:4px;font-size:14px}
    .producer{position:absolute;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;align-items:center}
    .producer.left{left:-130px}
    .producer.right{right:-130px}
    .producer button{width:120px;height:120px;font-size:64px;border:none;border-radius:50%;cursor:pointer;background:#fff}
    .producer .count{font-family:sans-serif;font-weight:700;margin-bottom:8px;font-size:20px}
    .producer .count.yellow{color:#facc15}
    .producer .count.red{color:#ef4444}
    .tree{position:absolute;height:auto;pointer-events:none;z-index:1;transform-origin:center bottom}
    .tree.shake{animation:shake 2s ease-in-out infinite}
    @keyframes shake{
      0%{transform:var(--base)}
      25%{transform:var(--base) rotate(3deg)}
      50%{transform:var(--base)}
      75%{transform:var(--base) rotate(-3deg)}
      100%{transform:var(--base)}
    }

    /* --- Customers --- */
    .customer{position:absolute;font-size:96px;line-height:1;transition:top 3s linear,left 3s linear}
    .customer .want{position:absolute;top:-40px;left:50%;transform:translateX(-50%);font-size:32px}
    .customer.waiting{animation:waiting .8s steps(2) infinite}
    @keyframes waiting{from{transform:translateY(0)}to{transform:translateY(-4px)}}

  </style>
</head>
<body>
  <div id="map">
    <div id="shopWrapper">
      <img id="shop" src="LemonShop.png" alt="Lemon Shop">
      <div id="cart">
        <div id="cartYellow" class="cartSide"></div>
        <div id="cartRed" class="cartSide"></div>
      </div>
      <div class="producer left">
        <div id="yellowStock" class="count yellow">0</div>
        <button id="makeYellow" class="yellow">üçã</button>
      </div>
      <div class="producer right">
        <div id="redStock" class="count red">0</div>
        <button id="makeRed" class="red">üçì</button>
      </div>
    </div>
  </div>
  <script>
    const treeImages=['Tree-1.png','Tree-2.png','Tree-3.png'];
    const map=document.getElementById('map');
    const shop=document.getElementById('shop');
    const cart=document.getElementById('cart');

    function overlaps(a,b){
      return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
    }

    function addTree(x,y,size){
      const img=document.createElement('img');
      img.src=treeImages[Math.floor(Math.random()*treeImages.length)];
      img.className='tree';
      img.style.width=size+'px';
      img.style.left=x+'px';
      img.style.top=y+'px';
      const angle=Math.random()*40-20;
      const flip=Math.random()<0.5?' scaleX(-1)':'';
      const base=`rotate(${angle}deg)${flip}`;
      img.style.setProperty('--base', base);
      img.style.transform=base;
      if(Math.random()<0.3) img.classList.add('shake');
      map.appendChild(img);
    }

    function placeTrees(){
      const w=map.clientWidth; const h=map.clientHeight;
      const shopRect=shop.getBoundingClientRect();
      const mapRect=map.getBoundingClientRect();
      const shopBox={x:shopRect.left-mapRect.left,y:shopRect.top-mapRect.top,w:shopRect.width,h:shopRect.height};
      const pathWidth=120;
      const yCenter=shopBox.y+shopBox.h/2;
      const verticalPath={x:w/2-pathWidth/2,y:yCenter-pathWidth/2,w:pathWidth,h:h-(yCenter-pathWidth/2)};
      const horizontalPath={x:0,y:yCenter-pathWidth/2,w:w,h:pathWidth};

      const borderSize=60;
      for(let x=0;x<w;x+=borderSize){
        const topRect={x:x,y:0,w:borderSize,h:borderSize};
        if(!overlaps(topRect,shopBox) && !overlaps(topRect,verticalPath) && !overlaps(topRect,horizontalPath)) addTree(x,0,borderSize);
        const bottomRect={x:x,y:h-borderSize,w:borderSize,h:borderSize};
        if(!overlaps(bottomRect,shopBox) && !overlaps(bottomRect,verticalPath) && !overlaps(bottomRect,horizontalPath)) addTree(x,h-borderSize,borderSize);
      }
      for(let y=0;y<h;y+=borderSize){
        const leftRect={x:0,y:y,w:borderSize,h:borderSize};
        if(!overlaps(leftRect,shopBox) && !overlaps(leftRect,verticalPath) && !overlaps(leftRect,horizontalPath)) addTree(0,y,borderSize);
        const rightRect={x:w-borderSize,y:y,w:borderSize,h:borderSize};
        if(!overlaps(rightRect,shopBox) && !overlaps(rightRect,verticalPath) && !overlaps(rightRect,horizontalPath)) addTree(w-borderSize,y,borderSize);
      }
    }

    window.addEventListener('load', placeTrees);

    const yellowStockEl=document.getElementById('yellowStock');
    const redStockEl=document.getElementById('redStock');
    const cartYellow=document.getElementById('cartYellow');
    const cartRed=document.getElementById('cartRed');
    let yellowStock=0;
    let redStock=0;
    const yellowQueue=[];
    const redQueue=[];

    function addCup(type){
      const cup=document.createElement('span');
      cup.className='cup';
      const fruit=type==='yellow'?'üçã':'üçì';
      cup.innerHTML=`ü•§<span class="fruit">${fruit}</span>`;
      if(type==='yellow') cartYellow.appendChild(cup); else cartRed.appendChild(cup);
    }

    function removeCup(type){
      const cart=type==='yellow'?cartYellow:cartRed;
      const first=cart.firstElementChild;
      if(first) cart.removeChild(first);
    }

    function serveCustomers(type){
      const queue=type==='yellow'?yellowQueue:redQueue;
      let stock=type==='yellow'?yellowStock:redStock;
      while(queue.length>0 && stock>0 && queue[0].arrived){
        const cust=queue.shift();
        cust.el.classList.remove('waiting');
        const wantSpan=cust.el.querySelector('.want');
        wantSpan && wantSpan.remove();
        cust.el.textContent='ü•§üôÇ'; // show customer taking the drink
        removeCup(type);
        stock--;
        const exitLeft=Math.random()<0.5;
        const exitX=exitLeft?-100:map.clientWidth+100;
        cust.el.style.left=exitX+'px';
        cust.el.addEventListener('transitionend',()=>cust.el.remove(),{once:true});
      }
      if(type==='yellow'){
        yellowStock=stock; yellowStockEl.textContent=yellowStock;
      }else{
        redStock=stock; redStockEl.textContent=redStock;
      }
      if(queue.length>0 && queue[0].arrived && stock===0){
        queue[0].el.classList.add('waiting');
      }
    }

    function spawnCustomer(){
      const type=Math.random()<0.5?'yellow':'red';
      const cust=document.createElement('div');
      cust.className='customer '+type;
      const want=type==='yellow'? 'üçã' : 'üçì';
      cust.innerHTML=`<span class="want">${want}</span>üôÇ`;
      const size=96;
      const startX=map.clientWidth/2-size/2;
      const startY=map.clientHeight;
      const cartRect=cart.getBoundingClientRect();
      const mapRect=map.getBoundingClientRect();
      const targetX=startX; // move straight up so customers stay in line
      const targetY=cartRect.top+cartRect.height-mapRect.top+10; // stand just below cart
      cust.style.left=startX+'px';
      cust.style.top=startY+'px';
      map.appendChild(cust);
      const obj={el:cust,arrived:false};
      if(type==='yellow') yellowQueue.push(obj); else redQueue.push(obj);
      requestAnimationFrame(()=>{
        cust.style.left=targetX+'px';
        cust.style.top=targetY+'px';
      });
      cust.addEventListener('transitionend',e=>{
        if(e.propertyName!=='top') return; // ensure vertical move finished
        obj.arrived=true;
        cust.classList.add('waiting');
        serveCustomers(type); // pick up drink if already prepared
      },{once:true});
    }

    setInterval(spawnCustomer,3000);

    document.getElementById('makeYellow').addEventListener('click',()=>{
      if(yellowStock>=12) return;
      yellowStock++;
      yellowStockEl.textContent=yellowStock;
      addCup('yellow');
      serveCustomers('yellow');
    });

    document.getElementById('makeRed').addEventListener('click',()=>{
      if(redStock>=12) return;
      redStock++;
      redStockEl.textContent=redStock;
      addCup('red');
      serveCustomers('red');
    });
  </script>
</body>
</html>
